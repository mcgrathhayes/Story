This is chapter 4 on the main branch